<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload RVT and Image Files</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }
        h1 {
            color: #333;
        }
        form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        .progress {
            display: none;
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 0;
            height: 20px;
            background-color: #28a745;
            border-radius: 4px;
            text-align: center;
            line-height: 20px;
            color: white;
        }
        #documents {
            margin-top: 20px;
        }
        .document-card {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
            width: 300px;
            display: inline-block;
            vertical-align: top;
            margin-right: 20px;
        }
        .document-card img {
            max-width: 100%;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .document-actions {
            margin-top: 10px;
        }
        .document-actions button {
            background-color: #dc3545;
            margin-right: 5px;
        }
        .document-actions button:hover {
            background-color: #c82333;
        }
        .document-actions button.edit {
            background-color: #ffc107;
        }
        .document-actions button.edit:hover {
            background-color: #e0a800;
        }
        #loadMore {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #loadMore:hover {
            background-color: #0056b3;
        }
        #searchForm {
            margin-bottom: 20px;
        }
        #searchForm input {
            width: calc(100% - 40px);
            display: inline-block;
        }
    </style>
</head>
<body>
    <h1>Upload RVT and Image Files</h1>
    <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="location">Location:</label>
        <input type="text" id="location" name="location" required>

        <label for="collection">Select Collection:</label>
        <select id="collection" name="collection" required onchange="loadDocuments()"></select>

        <label for="rvtFile">RVT File:</label>
        <input type="file" id="rvtFile" name="rvtFile" accept=".rvt" required>

        <label for="imageFile">Image File:</label>
        <input type="file" id="imageFile" name="imageFile" accept="image/*" required>
        
        <label for="input_link">Input Link:</label>
        <input type="url" id="input_link" name="input_link" required>

        <div class="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <button type="submit">Upload</button>
    </form>

    <div id="documents">
        <h2>Documents</h2>
        <form id="searchForm" onsubmit="event.preventDefault();">
            <input type="text" id="searchQuery" placeholder="Search documents...">
        </form>
        <div id="documentList"></div>
        <button id="loadMore" onclick="loadMoreDocuments()">Load More</button>
    </div>

    <script>
        let currentCollection = '';
        let skip = 0;
        const limit = 10;
        let searchQuery = '';

        async function loadCollections() {
            const response = await fetch('/collections');
            const collections = await response.json();
            const collectionSelect = document.getElementById('collection');

            collectionSelect.innerHTML = '';

            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection;
                option.textContent = collection;
                collectionSelect.appendChild(option);
            });

            loadDocuments(); // Load documents for the first collection
        }

        document.addEventListener('DOMContentLoaded', loadCollections);

        async function loadDocuments() {
            currentCollection = document.getElementById('collection').value;
            skip = 0;
            searchQuery = '';
            document.getElementById('documentList').innerHTML = '';
            document.getElementById('loadMore').style.display = 'none';
            fetchDocuments();
        }

        async function fetchDocuments() {
            if (!currentCollection) return;

            const response = await fetch(`/collection/${currentCollection}/documents?limit=${limit}&skip=${skip}&search=${encodeURIComponent(searchQuery)}`);
            const documents = await response.json();
            const documentList = document.getElementById('documentList');

            if (documents.length === 0) {
                document.getElementById('loadMore').style.display = 'none';
            } else {
                documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.classList.add('document-card');
                    card.innerHTML = `
                        <img src="${doc.linkanh}" alt="${doc.name}">
                        <div>${doc.name}</div>
                        <div>${doc.location}</div>
                        <div class="document-actions">
                            <button class="edit" onclick="editDocument('${doc._id}')">Edit</button>
                            <button onclick="deleteDocument('${doc._id}')">Delete</button>
                        </div>
                    `;
                    documentList.appendChild(card);
                });
                skip += limit;
                document.getElementById('loadMore').style.display = 'block';
            }
        }

        function loadMoreDocuments() {
            fetchDocuments();
        }

        async function editDocument(documentId) {
            const newName = prompt('Enter new name:');
            const newLocation = prompt('Enter new location:');
            if (newName && newLocation) {
                const response = await fetch(`/collection/${currentCollection}/document/${documentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName, location: newLocation })
                });
                if (response.ok) {
                    loadDocuments();
                } else {
                    alert('Failed to edit document');
                }
            }
        }

        async function deleteDocument(documentId) {
            if (confirm('Are you sure you want to delete this document?')) {
                const response = await fetch(`/collection/${currentCollection}/document/${documentId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    loadDocuments();
                } else {
                    alert('Failed to delete document');
                }
            }
        }

        function debounce(func, delay) {
            let debounceTimer;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => func.apply(context, args), delay);
            }
        }

        async function searchDocuments() {
            searchQuery = document.getElementById('searchQuery').value;
            skip = 0;
            document.getElementById('documentList').innerHTML = '';
            document.getElementById('loadMore').style.display = 'none';
            fetchDocuments();
        }

        const debouncedSearch = debounce(searchDocuments, 300);

        document.getElementById('searchQuery').addEventListener('input', debouncedSearch);

        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.querySelector('.progress');

        // Update progress bar based on percentage
        function updateProgressBar(percentage) {
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        document.getElementById('uploadForm').addEventListener('submit', function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', function (event) {
                if (event.lengthComputable) {
                    const percentage = Math.round((event.loaded / event.total) * 99);
                    updateProgressBar(percentage);
                }
            });

            xhr.addEventListener('load', function () {
                if (xhr.status === 200) {
                    alert('Upload successful!');
                    loadDocuments();
                } else {
                    alert('Upload failed!');
                }
                progressContainer.style.display = 'none';
                updateProgressBar(0);
            });

            xhr.addEventListener('error', function () {
                alert('Upload failed!');
                progressContainer.style.display = 'none';
                updateProgressBar(0);
            });

            xhr.open('POST', '/upload');
            xhr.send(formData);

            progressContainer.style.display = 'block';
            updateProgressBar(0);
        });
    </script>
</body>
</html>
